<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="color-scheme" content="light dark">
  <title>Interview Notes Tracker</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.lime.min.css">
  <style>
    :root {
      --note-timestamp-width: 120px;
    }
    
    body {
      padding-top: 1rem;
    }
    
    .header-row {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      margin-bottom: 1.5rem;
    }
    
    .header-row input[type="text"] {
      flex: 1;
      margin-bottom: 0;
      font-size: 1.25rem;
      font-weight: 600;
    }
    
    .header-buttons {
      display: flex;
      gap: 0.5rem;
      flex-shrink: 0;
    }
    
    .header-buttons button {
      margin-bottom: 0;
      padding: 0.5rem 1rem;
    }
    
    #notesContainer {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    
    .note-card {
      display: flex;
      gap: 1rem;
      align-items: flex-start;
      padding: 0;
      margin: 0;
    }
    
    .timestamp-col {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      min-width: var(--note-timestamp-width);
      padding-top: 0.5rem;
    }
    
    .timestamp-col input.timestamp-input {
      width: var(--note-timestamp-width);
      text-align: center;
      font-family: monospace;
      font-size: 0.9rem;
      padding: 0.25rem 0.5rem;
      margin-bottom: 0.25rem;
    }
    
    .delta {
      font-size: 0.75rem;
      color: var(--pico-muted-color);
      font-family: monospace;
    }
    
    .note-content {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    
    .note-content textarea {
      resize: none;
      overflow: hidden;
      min-height: 80px;
      margin-bottom: 0;
    }
    
    .delete-note {
      padding: 0.25rem 0.5rem;
      font-size: 0.75rem;
      align-self: flex-start;
      margin-top: 0.5rem;
    }
    
    .add-note-container {
      display: flex;
      justify-content: center;
      margin-top: 1rem;
      margin-bottom: 2rem;
    }
    
    #addNoteBtn {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      font-size: 1.5rem;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    /* Modal styling */
    #exportModal article {
      max-width: 700px;
      width: 90vw;
    }
    
    #markdownPreview {
      background: var(--pico-card-background-color);
      border: 1px solid var(--pico-muted-border-color);
      border-radius: var(--pico-border-radius);
      padding: 1rem;
      max-height: 400px;
      overflow-y: auto;
      white-space: pre-wrap;
      font-family: monospace;
      font-size: 0.9rem;
    }
    
    .modal-buttons {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    
    .modal-buttons button {
      flex: 1;
      min-width: 120px;
    }
    
    /* Empty state */
    .empty-state {
      text-align: center;
      padding: 3rem 1rem;
      color: var(--pico-muted-color);
    }
    
    .empty-state p {
      margin-bottom: 0;
    }
    
    /* Toast notification */
    .toast {
      position: fixed;
      bottom: 2rem;
      left: 50%;
      transform: translateX(-50%);
      background: var(--pico-primary);
      color: var(--pico-primary-inverse);
      padding: 0.75rem 1.5rem;
      border-radius: var(--pico-border-radius);
      opacity: 0;
      transition: opacity 0.3s ease;
      z-index: 9999;
    }
    
    .toast.show {
      opacity: 1;
    }
    
    /* Mobile adjustments */
    @media (max-width: 576px) {
      .header-row {
        flex-direction: column;
      }
      
      .header-row input[type="text"] {
        width: 100%;
      }
      
      .header-buttons {
        width: 100%;
        justify-content: stretch;
      }
      
      .header-buttons button {
        flex: 1;
      }
      
      .note-card {
        flex-direction: column;
        gap: 0.5rem;
      }
      
      .timestamp-col {
        flex-direction: row;
        align-items: center;
        gap: 1rem;
        min-width: auto;
        width: 100%;
        padding-top: 0;
      }
      
      .modal-buttons {
        flex-direction: column;
      }
      
      .modal-buttons button {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <main class="container">
    <!-- Header with candidate name and action buttons -->
    <div class="header-row">
      <input type="text" id="candidateName" placeholder="Candidate Name" autocomplete="off">
      <div class="header-buttons">
        <button id="saveExportBtn">Save & Export</button>
        <button id="resetBtn" class="secondary outline">Reset</button>
      </div>
    </div>
    
    <!-- Notes container -->
    <div id="notesContainer">
      <!-- Notes will be rendered here -->
    </div>
    
    <!-- Add note button -->
    <div class="add-note-container">
      <button id="addNoteBtn">+</button>
    </div>
  </main>
  
  <!-- Export Modal -->
  <dialog id="exportModal">
    <article>
      <header>
        <button aria-label="Close" rel="prev" id="closeModalBtn"></button>
        <h3>Export Interview Notes</h3>
      </header>
      <pre id="markdownPreview"></pre>
      <footer class="modal-buttons">
        <button id="copyBtn">Copy to Clipboard</button>
        <button id="downloadBtn" class="secondary">Download .md</button>
      </footer>
    </article>
  </dialog>
  
  <!-- Toast notification -->
  <div id="toast" class="toast"></div>

  <script>
    // ============================================
    // State Management
    // ============================================
    const STORAGE_KEY = 'interview-notes-tracker';
    
    let state = {
      candidateName: '',
      notes: [] // { id: string, timestamp: number (ms), text: string }
    };
    
    // ============================================
    // DOM Elements
    // ============================================
    const candidateNameInput = document.getElementById('candidateName');
    const notesContainer = document.getElementById('notesContainer');
    const addNoteBtn = document.getElementById('addNoteBtn');
    const saveExportBtn = document.getElementById('saveExportBtn');
    const resetBtn = document.getElementById('resetBtn');
    const exportModal = document.getElementById('exportModal');
    const closeModalBtn = document.getElementById('closeModalBtn');
    const markdownPreview = document.getElementById('markdownPreview');
    const copyBtn = document.getElementById('copyBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const toast = document.getElementById('toast');
    
    // ============================================
    // Utility Functions
    // ============================================
    function generateId() {
      return Date.now().toString(36) + Math.random().toString(36).substr(2);
    }
    
    function formatTime(timestamp) {
      const date = new Date(timestamp);
      return date.toTimeString().split(' ')[0]; // HH:MM:SS
    }
    
    function parseTimeToTimestamp(timeStr, referenceTimestamp) {
      // Parse HH:MM:SS and create a timestamp for the same day as reference
      const [hours, minutes, seconds] = timeStr.split(':').map(Number);
      const refDate = new Date(referenceTimestamp);
      const newDate = new Date(refDate);
      newDate.setHours(hours, minutes, seconds, 0);
      return newDate.getTime();
    }
    
    function formatDelta(deltaMs) {
      if (deltaMs <= 0) return '';
      
      const totalSeconds = Math.floor(deltaMs / 1000);
      const hours = Math.floor(totalSeconds / 3600);
      const minutes = Math.floor((totalSeconds % 3600) / 60);
      const seconds = totalSeconds % 60;
      
      let parts = [];
      if (hours > 0) parts.push(`${hours}h`);
      if (minutes > 0) parts.push(`${minutes}m`);
      if (seconds > 0 || parts.length === 0) parts.push(`${seconds}s`);
      
      return '+' + parts.join(' ');
    }
    
    function showToast(message) {
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 2000);
    }
    
    function autoResizeTextarea(textarea) {
      textarea.style.height = 'auto';
      textarea.style.height = textarea.scrollHeight + 'px';
    }
    
    // ============================================
    // Persistence
    // ============================================
    function saveState() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }
    
    function loadState() {
      const saved = localStorage.getItem(STORAGE_KEY);
      if (saved) {
        try {
          state = JSON.parse(saved);
        } catch (e) {
          console.error('Failed to load state:', e);
          state = { candidateName: '', notes: [] };
        }
      }
    }
    
    // ============================================
    // Markdown Generation
    // ============================================
    function generateMarkdown() {
      const lines = [];
      
      // Title with candidate name
      const name = state.candidateName.trim() || 'Interview';
      lines.push(`# ${name}`);
      lines.push('');
      
      // Date
      const interviewDate = state.notes.length > 0 
        ? new Date(state.notes[0].timestamp).toLocaleDateString()
        : new Date().toLocaleDateString();
      lines.push(`**Date:** ${interviewDate}`);
      lines.push('');
      lines.push('---');
      lines.push('');
      lines.push('## Notes');
      lines.push('');
      
      // Notes
      state.notes.forEach((note, index) => {
        const time = formatTime(note.timestamp);
        let deltaStr = '';
        if (index > 0) {
          const delta = note.timestamp - state.notes[index - 1].timestamp;
          deltaStr = ` (${formatDelta(delta)})`;
        }
        
        lines.push(`### ${time}${deltaStr}`);
        lines.push('');
        lines.push(note.text.trim() || '_No content_');
        lines.push('');
      });
      
      return lines.join('\n');
    }
    
    // ============================================
    // Rendering
    // ============================================
    function renderNotes() {
      notesContainer.innerHTML = '';
      
      if (state.notes.length === 0) {
        notesContainer.innerHTML = `
          <div class="empty-state">
            <p>No notes yet. Click the <strong>+</strong> button to add your first note.</p>
          </div>
        `;
        return;
      }
      
      state.notes.forEach((note, index) => {
        const prevNote = index > 0 ? state.notes[index - 1] : null;
        const delta = prevNote ? note.timestamp - prevNote.timestamp : 0;
        
        const noteEl = document.createElement('div');
        noteEl.className = 'note-card';
        noteEl.dataset.id = note.id;
        
        noteEl.innerHTML = `
          <div class="timestamp-col">
            <input type="text" class="timestamp-input" pattern="[0-9]{2}:[0-9]{2}:[0-9]{2}" inputmode="numeric" placeholder="HH:MM:SS" value="${formatTime(note.timestamp)}" data-note-id="${note.id}">
            <span class="delta">${formatDelta(delta)}</span>
          </div>
          <div class="note-content">
            <textarea placeholder="Enter your note..." data-note-id="${note.id}">${note.text}</textarea>
            <button class="delete-note secondary outline" data-note-id="${note.id}">Delete</button>
          </div>
        `;
        
        notesContainer.appendChild(noteEl);
        
        // Auto-resize textarea
        const textarea = noteEl.querySelector('textarea');
        autoResizeTextarea(textarea);
      });
      
      // Attach event listeners
      attachNoteListeners();
    }
    
    function attachNoteListeners() {
      // Textarea input handlers
      notesContainer.querySelectorAll('textarea').forEach(textarea => {
        textarea.addEventListener('input', (e) => {
          const noteId = e.target.dataset.noteId;
          const note = state.notes.find(n => n.id === noteId);
          if (note) {
            note.text = e.target.value;
            saveState();
          }
          autoResizeTextarea(e.target);
        });
      });
      
      // Time input handlers
      notesContainer.querySelectorAll('.timestamp-input').forEach(timeInput => {
        timeInput.addEventListener('change', (e) => {
          const noteId = e.target.dataset.noteId;
          const note = state.notes.find(n => n.id === noteId);
          if (note) {
            note.timestamp = parseTimeToTimestamp(e.target.value, note.timestamp);
            saveState();
            renderNotes(); // Re-render to update deltas
          }
        });
      });
      
      // Delete button handlers
      notesContainer.querySelectorAll('.delete-note').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const noteId = e.target.dataset.noteId;
          if (confirm('Delete this note?')) {
            state.notes = state.notes.filter(n => n.id !== noteId);
            saveState();
            renderNotes();
          }
        });
      });
    }
    
    // ============================================
    // Event Handlers
    // ============================================
    
    // Candidate name change
    candidateNameInput.addEventListener('input', (e) => {
      state.candidateName = e.target.value;
      saveState();
    });
    
    // Add new note
    addNoteBtn.addEventListener('click', () => {
      const newNote = {
        id: generateId(),
        timestamp: Date.now(),
        text: ''
      };
      state.notes.push(newNote);
      saveState();
      renderNotes();
      
      // Focus the new textarea
      const newTextarea = notesContainer.querySelector(`textarea[data-note-id="${newNote.id}"]`);
      if (newTextarea) {
        newTextarea.focus();
      }
    });
    
    // Save & Export
    saveExportBtn.addEventListener('click', () => {
      const markdown = generateMarkdown();
      markdownPreview.textContent = markdown;
      exportModal.showModal();
    });
    
    // Close modal
    closeModalBtn.addEventListener('click', () => {
      exportModal.close();
    });
    
    // Copy to clipboard
    copyBtn.addEventListener('click', async () => {
      const markdown = markdownPreview.textContent;
      try {
        await navigator.clipboard.writeText(markdown);
        showToast('Copied to clipboard!');
      } catch (e) {
        // Fallback for older browsers
        const textarea = document.createElement('textarea');
        textarea.value = markdown;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
        showToast('Copied to clipboard!');
      }
    });
    
    // Download .md file
    downloadBtn.addEventListener('click', () => {
      const markdown = markdownPreview.textContent;
      const filename = (state.candidateName.trim() || 'interview-notes')
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/^-|-$/g, '') + '.md';
      
      const blob = new Blob([markdown], { type: 'text/markdown' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      showToast('Download started!');
    });
    
    // Reset
    resetBtn.addEventListener('click', () => {
      if (confirm('Are you sure you want to reset all data? This will clear the candidate name and all notes.')) {
        state = { candidateName: '', notes: [] };
        saveState();
        candidateNameInput.value = '';
        renderNotes();
        showToast('All data cleared');
      }
    });
    
    // Close modal on backdrop click
    exportModal.addEventListener('click', (e) => {
      if (e.target === exportModal) {
        exportModal.close();
      }
    });
    
    // ============================================
    // Initialization
    // ============================================
    function init() {
      loadState();
      candidateNameInput.value = state.candidateName;
      renderNotes();
    }
    
    // Start the app
    init();
  </script>
</body>
</html>
